# Variance-Guided Risk (ARX–GARCHX)

Minimal, reproducible code for a variance-guided mean–variance model with autoregressive dynamics. The repo includes:
- a **fast demo** (single scenario, single fit), and
- a **replication script** that regenerates the RMSE/Bias figures used in the manuscript.

---

## Repository structure

```
.
├─ R/
│  ├─ simulator_scenarios.r      # scenario generators (1–4)
│  └─ temporalVarGuid1.r         # core model: lmvt(), predict.lmvt()
├─ scripts/
│  ├─ 00_setup_env.R             # seeds + single-thread settings + session info
│  ├─ demo_algorithm.R           # one scenario, one fit (fast demo)
│  └─ run_main_results.R         # replication of paper-style figures
├─ outputs/
│  └─ .gitkeep                   # figures/CSVs written here
├─ LICENSE
├─ .gitignore
└─ README.md
```

---

## Quick start

**Install packages (first time):**
```r
install.packages(c("ggplot2","dplyr","tidyr"))
```

**Run the fast demo (≈1–2 minutes):**
```bash
Rscript scripts/demo_algorithm.R
```
This simulates one scenario via `simulate_scenario_smallT()`, fits the **variance-guided** model once (`use_x_in_variance = TRUE`), predicts \hat{μ}, \hat{σ}, computes exceedance risk at a pooled 90th-percentile cutoff, and writes two PNGs to `outputs/`.

**Reproduce main simulation figures (longer):**
```bash
Rscript scripts/run_main_results.R
```
This regenerates RMSE/Bias boxplots for `T ∈ {120, 240}` across scenarios and models A–D, and saves raw/summary CSVs.

---

## Order notation (paper vs. code) and current limitation for K

We use **(P,Q,L,R)** in the paper and **(p,q,r,s_ord)** in code:

- **P ↔ p**: AR order in the **mean** (lags of y)  
- **Q ↔ q**: distributed-lag order for **exogenous X** in the mean  
- **L ↔ r**: ARCH order in the **variance** (lags of e^2)  
- **R ↔ s_ord**: GARCH order in the **variance** (lags of σ^2)

A compact sketch (for reference only):
```
μ_{s,t} = α_s + Σ_{i=1..P} φ_i y_{s,t-i} + Σ_{j=0..Q} X_{s,t-j}^T β_j
σ^2_{s,t} = ω_s + Σ_{i=1..L} a_i e_{s,t-i}^2 + Σ_{j=1..R} b_j σ^2_{s,t-j}
            + X_{s,t}^T γ   (if use_x_in_variance = TRUE)
```

> **Implementation note on the variance-lag K:**  
> The current implementation does **not** expose a separate variance lag order **K** for the exogenous regressors. The variance equation reuses the **same X columns** as the mean. Practically, that ties K to whatever X-lag structure you include in your design matrix for the mean. If you include only contemporaneous X, this behaves like K = 0; if you include lags up to Q in your X design, the variance sees those same lags.

---

## Using the model on your data

Your data frame should include `s` (subject id), `t` (time), `y` (outcome), and covariates.

```r
# Load the model code
source("R/temporalVarGuid1.r")

# Example mapping: paper (P,Q,L,R) = (1,0,1,1)  ↔  code (p,q,r,s_ord) = (1,0,1,1)
fit <- lmvt(
  df,
  p = 1, q = 0, r = 1, s_ord = 1,
  lambda_beta = 0.01, lambda_gamma = 0.01,
  standardize_X = TRUE,
  use_x_in_variance = TRUE   # variance uses the same X columns as the mean
)

pred <- predict.lmvt(fit, newdata = df, innov_g = TRUE)

# Exceedance risk at a pooled 90th percentile cutoff
c_cut <- quantile(df$y, 0.90, na.rm = TRUE)
z <- (c_cut - pred$muhat) / pmax(pred$sigmahat, 1e-8)
p_exceed <- 1 - pnorm(z)
```

---

## Outputs

- **Demo** (subject-level view):
  - `outputs/scen<id>_subj1_y_mu_band.png`
  - `outputs/scen<id>_subj1_risk_vs_hits.png`
- **Main results** (boxplots):
  - `outputs/ABCD_s15_T120_ar1_RMSE.png`
  - `outputs/ABCD_s15_T120_ar1_Bias.png`
  - `outputs/ABCD_s15_T240_ar1_RMSE.png`
  - `outputs/ABCD_s15_T240_ar1_Bias.png`
- **CSV artifacts**:
  - `outputs/rep_raw_s15t120_by_rep_30reps.csv`
  - `outputs/rep_raw_s15t240_by_rep_30reps.csv`
  - `outputs/rep_summary_s15t120_30reps.csv`
  - `outputs/rep_summary_s15t240_30reps.csv`

---

## Requirements & reproducibility

- **R ≥ 4.2**
- Packages: **ggplot2**, **dplyr**, **tidyr**

`scripts/00_setup_env.R`:
- fixes a global RNG seed,
- caps BLAS/LAPACK to single thread for determinism,
- writes a one-time `session_info.txt` in the repo root.

### (Optional) Lock dependencies with renv
```r
install.packages("renv")
renv::init(); renv::snapshot()   # creates renv.lock for reproducible restores
```

---

## Code & data availability (for manuscript)

**Code.** All code to implement the method and reproduce figures is included here. Minimal example: `scripts/demo_algorithm.R`; full replication: `scripts/run_main_results.R`.

**Data.** All analyses use simulated data generated by `R/simulator_scenarios.r`. No external datasets are required.

---

## License

Released under the MIT License (see `LICENSE`).

---

## Citation

If you use this repository, please cite the accompanying manuscript. A DOI (Zenodo/OSF) and `CITATION.cff` will be added upon release.
